---
title: "flat_plot_urgara.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
fusen::load_flat_functions()
```

```{r development-inflat}
fusen::inflate(flat_file = "dev/flat_plot_urgara.Rmd", vignette_name = "test", open_vignette = F)
```

# plot_diag_charge
    
```{r development-plot_diag_charge}
library(tidyverse)
library(lubridate)

data = tibble(ENTREE = "27/12/1993 15h15h20",
              SORTIE = "28/12/1993 12h02h30")
entry = "ENTREE"
exit = "SORTIE"
strata = NULL
```

    
```{r function-plot_diag_charge}
#' Plot a charge diagram
#' 
#' @description Plot a charge diagram from a table with an entre datetime and exit datetime. A charge diagram shows the number of individuals and their time of arrival for each hour/half hour of a day.
#' 
#' @param data A data frame or tibble.
#' @param entry The name of the column containing the datetime of entry. The colmum must be of class POSIXct or character in the format DD/MM/YYYY HH:MM:SS.
#' @param exit The name of the column containing the datetime of exit. The colmum must be of class POSIXct or character in the format DD/MM/YYYY HH:MM:SS.
#' @param strata The name of the colum(s) containing statas (e.g. structures) to average the charge over.
#' 
#' @return A list. tab contains the table used to make the charge diagram. plot contains the charge diagram
#' 
#' @export
#' 
plot_diag_charge <- function(data, entry, exit, strata = NULL){
  #type check
  type_entry = dplyr::pull(data, entry) %>% class
  type_exit = dplyr::pull(data, entry) %>% class
  if(type_entry != type_exit)stop("entry and exit must have the same type")
  
  #rename entry/exit/strata column
  data <- data %>%
    dplyr::select(dh_entry = {entry}, dh_exit = {exit}, strata = {strata})
  
  #convertion to dmy_hms
  if(type_entry == "character"){
    data <- data %>%
      dplyr::mutate(dplyr::across(c("dh_entry", "dh_exit"), lubridate::dmy_hms))
  }
  
  #computation of the table of charge
  tab_charge <- fct_tab_charge(data)
  
  #plotting of the charge diagram
  plot_charge <- fct_plot_charge(tab_charge)
  
  return(list(tab = tab_charge,
              plot = plot_charge))
}
```
  
```{r example-plot_diag_charge}
# plot_diag_charge()
```
  
```{r tests-plot_diag_charge}
test_that("plot_diag_charge works", {
  expect_true(inherits(plot_diag_charge, "function")) 
})
```
  
# plot_add_logo
    
```{r function-plot_add_logo}
#' Add company logo to a plot
#' 
#' @description Adds a company logo (by default Urg'Ara) to a plot. A custom logo can be used by specifying a path to the logo
#' 
#' @param plot A ggplot object
#' @param logo The path to a .jpg logo. If NULL, the Urg'Ara logo will be used instead
#' @param height The height of the logo in proportion of the graph (default 0.1)
#' @param width The width of the logo in proportion of the graph (default 0.2)
#' 
#' @return a ggplot2 object
#' 
#' @export
plot_add_logo <- function(plot, logo = NULL, height = 0.1, width = 0.2){
  #type check
  if(!is.numeric(height) | !is.numeric(width)){
    stop("Height and width must be numerical")} else
      if(!dplyr::between(height, 0, 1) | !dplyr::between(width, 0, 1)){
        stop("Height and width myst be between 0 and 1")
      }
  if(!ggplot2::is.ggplot(plot)) stop("plot must be a ggplot object")
  if(!is.null(logo)){
    if(!stringr::str_detect(logo, ".jpg$")) stop("Logo must point to a .jpg file")
    if(!file.exists(logo)) stop(paste0(logo, " does not exist"))
  }

  
  #creation of a ggplot containing the logo
  if(is.null(logo)){logo = paste0(path.package(package = "rUrgAra"), "/img/logo_urgara.jpg")}
  logo_jpg = grid::rasterGrob(jpeg::readJPEG(logo), interpolate = T)
  plot_logo = ggplot2::ggplot(mapping = ggplot2::aes(x = 1, y = 1)) +
    ggplot2::theme_void() +
    ggplot2::annotation_custom(logo_jpg)
  
  #Making a grid.arrange with the input plot and the logo
  plot_logoed <- gridExtra::grid.arrange(grobs = list(plot +
                                                        ggplot2::theme(plot.margin = ggplot2::margin(t = 0)),
                                                      plot_logo +
                                                        ggplot2::theme(plot.margin = ggplot2::margin(t = 0, 0, 0, 0))),
                                         heights = c(1-height, height), widths = c(1-width, width),
                                         layout_matrix = rbind(c(1, 1),
                                                               c(NA, 2)))
  return(plot_logoed)
}
```
  
```{r example-plot_add_logo}
library(ggplot2)
plot_test = ggplot(data.frame(), ggplot2::aes(x = 1, y = 1)) +
  geom_point()
plot_add_logo(plot = plot_test)
```
  
```{r tests-plot_add_logo}
test_that("plot_add_logo works", {
  expect_true(inherits(plot_add_logo, "function"))
})
```
  

# utils plot
## fct_tab_charge
    
```{r function-fct_tab_charge}
#' Title
#' 
#' Description
#' 
#' @return a tibble
#' 
#' @noRd
fct_tab_charge <- function(tab){
    placeholder = dplyr::tibble()
    return(placeholder)
}
```
  
```{r tests-fct_tab_charge}
test_that("rurgara_tab_charge works", {
  expect_true(inherits(fct_tab_charge, "function")) 
})
```
  

## fct_plot_charge
    
```{r function-fct_plot_charge}
#' Title
#' 
#' Description
#' 
#' @return a ggplot
#' 
#' @noRd
fct_plot_charge <- function(tab){
    placeholder = ggplot2::ggplot(data.frame(), ggplot2::aes(x = 1, y = 1)) +
      ggplot2::geom_point()
    return(placeholder)
}
```
  
```{r tests-fct_plot_charge}
test_that("fct_plot_charge works", {
  expect_true(inherits(fct_plot_charge, "function")) 
})
```
  
